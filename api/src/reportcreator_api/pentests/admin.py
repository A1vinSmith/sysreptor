from django.contrib import admin

from reportcreator_api.pentests.models import FindingTemplate, PentestFinding, PentestProject, PentestReport, ProjectType, UploadedImage, UploadedAsset
from reportcreator_api.utils.admin import admin_change_url, admin_changelist_url


class BaseAdmin(admin.ModelAdmin):
    date_hierarchy = 'created'

    def get_readonly_fields(self, request, obj):
        readonly_fields = super().get_readonly_fields(request, obj)
        return readonly_fields + tuple(set([f for f in dir(self) if f.startswith('link_')]).difference(readonly_fields))


@admin.register(ProjectType)
class ProjectTypeAdmin(BaseAdmin):
    def link_projects(self, obj):
        return admin_changelist_url('Projects using this ProjectType', 'pentests', 'pentestproject', {'project_type_id': obj.id})

    def link_templates(self, obj):
        return admin_changelist_url('Finding Templates using this ProjectType', 'pentests', 'findingtemplate', {'project_type_id': obj.id})

    def link_uploaded_assets(self, obj):
        return admin_change_url('Uploaded assets', 'pentests', 'uploadedasset', {'projecttype_id': obj.id})


@admin.register(PentestProject)
class PentestProjectAdmin(BaseAdmin):
    def link_report(self, obj):
        return admin_change_url(obj.report.title, 'pentests', 'pentestreport', obj.report.id)

    def link_findings(self, obj):
        return admin_changelist_url('Findings of this project', 'pentests', 'pentestfinding', {'report_id': obj.report.id})

    def link_project_type(self, obj):
        return admin_change_url(obj.project_type.name, 'pentests', 'projecttype', obj.project_type.id)

    def link_uploaded_images(self, obj):
        return admin_changelist_url('Uploaded images', 'pentests', 'uploadedimage', {'pentestproject_id': obj.id})


@admin.register(PentestReport)
class PentestReportAdmin(BaseAdmin):
    def link_findings(self, obj):
        return admin_changelist_url('Findings of this report', 'pentests', 'pentestfinding', {'report_id': obj.id})

    def link_project(self, obj):
        return admin_change_url(obj.project.name, 'pentests', 'pentestproject', obj.project.id)

    def link_project_type(self, obj):
        return admin_change_url(obj.project.project_type.name, 'pentests', 'projecttype', obj.project.project_type.id)


@admin.register(PentestFinding)
class PentestFindingAdmin(BaseAdmin):
    def link_report(self, obj):
        return admin_change_url(obj.report.title, 'pentests', 'pentestreport', obj.report.id)

    def link_project(self, obj):
        return admin_change_url(obj.report.project.name, 'pentests', 'pentestproject', obj.report.project.id)


@admin.register(FindingTemplate)
class FindingTemplateAdmin(BaseAdmin):
    def link_project_type(self, obj):
        return admin_change_url(obj.project.project_type.name, 'pentests', 'projecttype', obj.project.project_type.id)


@admin.register(UploadedImage)
class UploadedImageAdmin(BaseAdmin):
    def link_project(self, obj):
        return admin_change_url(obj.project.name, 'pentests', 'pentestproject', obj.project.id)


@admin.register(UploadedAsset)
class UploadedAssetAdmin(BaseAdmin):
    def link_project_type(self, obj):
        return admin_change_url(obj.project_type.name, 'pentests', 'projecttype', obj.project_type.id)

